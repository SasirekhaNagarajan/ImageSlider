function processed(){++qTemp==qLen&&getAll({model:module}).then(function(e){var t=[],a=e.data||[];a.forEach(function(e){t.push(e[pK])}),self.postMessage({qProcess:"completed4",data:t})})}function qProcess(e){switch(e.type){case"getCachedData":getCachedData(e).then(function(t){self.postMessage({model:e.model,type:e.type,queryParams:e.queryParams,code:200,data:t,req:e.req,key:e.key})},function(){self.postMessage({model:e.model,type:e.type,queryParams:e.queryParams,code:400,req:e.req,key:e.key})});break;case"pushPayload":if(!e.data[e.model]){var t=e.data;e.data={},e.data[e.model]=t}case"findAll":case"findRecord":case"push":push(e,e.type).then(processed,processed);break;case"open":openIDB(e);break;case"create":addMultiple(e).then(processed,processed);break;case"createRecord":addData(e).then(processed,processed);break;case"delete":deleteMultiple(e).then(processed,processed);break;case"destroyRecord":case"deleteRecord":deleteData(e).then(processed,processed);break;case"update":updateMultiple(e).then(processed,processed);break;case"updateRecord":updateData(e).then(processed,processed);break;case"get":getData(e).then(function(t){if(void 0==t.data)self.postMessage({model:e.model,type:e.type,queryParams:e.queryParams,code:400,req:e.req,key:e.key});else{var a={};a[e.model]=t.data,self.postMessage({model:e.model,type:e.type,queryParams:e.queryParams,code:200,data:a,req:e.req,key:e.key})}},function(){self.postMessage({model:e.model,type:e.type,queryParams:e.queryParams,code:400,req:e.req,key:e.key})});break;case"getAll":getAll(e).then(function(t){if(Array.isArray(t.data)&&!t.data.length)self.postMessage({model:e.model,type:e.type,queryParams:e.queryParams,code:400,req:e.req});else{var a={};a[e.model]=t.data,self.postMessage({model:e.model,type:e.type,queryParams:e.queryParams,code:200,data:a,req:e.req})}},function(){self.postMessage({model:e.model,type:e.type,queryParams:e.queryParams,code:400,req:e.req})});break;case"close":idb.close();break;default:self.postMessage({msg:"No such actions defined "+e.type,data:e.data})}}function getCachedData(e){return new Promise(function(t,a){var r=e.model,n=(e.queryParams,e.req),o=e.key;getData({model:"__meta",key:r}).then(function(s){if(void 0==s.data)return a();var d=s.data.cache;d=d[n];var c=checkWithQp(d,e);if(-1==c)return a();var u,i=d[c];if("findRecord"==n){if(!i.key||!o||i.key!=o)return a();u=[o]}else u=i.data[r];var l=u.length,f=0,m=[];u.forEach(function(a,n){getData({model:r,key:a}).then(function(a){if(m[n]=a.data,++f==l){var r={};return r[e.model]=m,t(r)}})})})})}function postMsg(e){self.postMessage(e)}function push(e,t){return new Promise(function(a,r){var n=e.data,o=(n.length,e.model);checkAndInsert(o,e.data).then(function(r){return"pushPayload"==t?a():void getData({model:"__meta",key:o}).then(function(n){var s={};s.queryParams=e.queryParams;var d=s.data=e.data;"findRecord"==t&&(s.key=e.key);for(var c=d[o].length,u=0;c>u;u++)d[o][u]=r[u][pK];if(void 0==n.data){var i={};i.module=o,i.cache={},i.cache[t]=i.data||[],i.cache[t].push(s),addData({model:"__meta",data:i}).then(function(){return a()},function(){self.console.error("error adding ",i)})}else n.data.cache[t]=n.data.cache[t]||[],n.data.cache[t].push(s),updateData({model:"__meta",data:n.data}).then(function(){return a()},function(){self.console.error("error adding ",n.data)})})},function(){r()})})}function checkQpAndPush(e,t){t&&!Array.isArray(t)&&(t=[t]),t.forEach(function(a){var r=checkWithQp(e,t);-1==r?e.push(a):e[r].data=a})}function checkWithQp(e,t){var a=-1;return e=e||[],e.forEach(function(e,r){var n=e.queryParams||{},o=t.queryParams||{};if(n==o)return void(a=r);var s=Object.keys(n).length,d=Object.keys(o).length,c=0;if(s==d){for(var u in n)n[u]==o[u]&&c++;return c==s?void(a=r):void 0}}),a}function checkAndInsert(e,t){var a=!1;return new Promise(function(r,n){t=t[e],t=t||[],Array.isArray(t)||(t=[t]);var o=t.length,s=0;t.forEach(function(d){addData({model:e,data:d}).then(function(){return s++,s==o?a?n():r(t):void 0},function(){return a=!0,s++,s==o?a?n():r(t):void 0})})})}function openIDB(e){var t=e.name||"lyte",a=e.version||1,r=e.models,n=indexedDB.open(t,a);n.onupgradeneeded=function(e){idb=e.target.result,r&&r.forEach(function(e){idb.createObjectStore(e.modelName,{keyPath:e.pK})}),idb.createObjectStore("__meta",{keyPath:"module"}),self.postMessage({msg:"successfully upgraded db",type:"open"})},n.onblocked=function(){},n.onsuccess=function(e){idb=e.target.result,self.postMessage({msg:"successfully opened db",type:"open"})},n.onerror=function(){self.postMessage({msg:"error"})}}function addMultiple(e){return new Promise(function(t){var a=e.data.length,r=0;e.data.forEach(function(n){addData({model:e.model,data:n}).then(function(){return++r==a?t():void 0},function(){return++r==a?t():void 0})})})}function addData(e){return new Promise(function(t,a){var r=e.data,n=e.model,o=idb.transaction([n],"readwrite").objectStore(n),s=o.add(r);s.onsuccess=function(){return t({msg:"Successfully added data"})},s.onerror=function(){return a({msg:"Error while adding data"})},s.oncomplete=function(){return t({msg:"Successfully added data"})}})}function deleteMultiple(e){return new Promise(function(t){var a=e.data.length,r=0;e.data.forEach(function(n){deleteData({model:e.model,key:n}).then(function(){return++r==a?t():void 0},function(){return++r==a?t():void 0})})})}function deleteData(e){return new Promise(function(t){var a=e.model,r=e.key,n=idb.transaction([a],"readwrite").objectStore(a),o=n.delete(r);o.onsuccess=function(){return t({msg:"Successfully deleted data"})},o.onerror=function(){return t({msg:"Error while deleting data"})},o.oncomplete=function(){return t({msg:"Successfully deleted data"})}})}function updateMultiple(e){return new Promise(function(t){var a=e.data.length,r=0;e.data.forEach(function(){updateData({model:e.model,data:e.data}).then(function(){return++r==a?t():void 0},function(){return++r==a?t():void 0})})})}function updateData(e){return new Promise(function(t,a){{var r=e.model,n=e.data;e.key}getData(e).then(function(o){var s=o.data;if(void 0==o.data)addData(e).then(function(){return t({msg:"Successfully added data"})},function(){return a({msg:"Error while adding data"})});else{for(var d in n)s[d]=n[d];var c=idb.transaction([r],"readwrite").objectStore(r),u=c.put(s);u.onsuccess=function(){return t({msg:"Successfully updated data"})},u.onerror=function(){return t({msg:"Error while updating data"})},u.oncomplete=function(){return t({msg:"Successfully updated data"})}}},function(){a()})})}function getData(e){return new Promise(function(t,a){var r=e.model,n=e.key;if(idb&&idb.objectStoreNames.contains(r)){var o=idb.transaction([r],"readwrite").objectStore(r);n||(n=e.data?e.data[o.keyPath]:void 0);var s=o.get(n);s.onsuccess=function(e){return t({msg:"Successfully got data success",data:e.target.result})},s.onerror=function(){return a({msg:"Error while getting data"})},s.oncomplete=function(e){return t({msg:"Successfully got data complete",data:e.target.result})}}else self.postMessage({pause:!0,model:e.model,type:e.type})})}function getAll(e){return new Promise(function(t,a){var r=e.model;if(idb&&idb.objectStoreNames.contains(r)){var n=idb.transaction([r],"readwrite").objectStore(r),o=n.getAll();o.onsuccess=function(e){return t({msg:"Successfully got data",data:e.target.result})},o.onerror=function(){return a({msg:"Error while getting data"})},o.oncomplete=function(e){return t({msg:"Successfully got data",data:e.target.result})}}else self.postMessage({pause:!0,model:e.model,type:e.type})})}var idb,qLen,qTemp,pK,module;self.onmessage=function(e){var t=e.data;if("open"==t.type||idb)if("push"==t.type){qLen=qTemp=0,module=t.module,pK=void 0;var a=t.data;Array.isArray(a)||(a=[a]),pK=t.pK,qLen=a.length,a.forEach(function(e){qProcess(e,e.type)})}else qProcess(t,t.type);else self.postMessage({pause:!0,model:t.model,type:t.type})};