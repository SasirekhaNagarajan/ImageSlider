Lyte.Component.register("lyte-fileupload",{_template:'<template tag-name="lyte-fileupload">\n\t<input class="fileuploadInput {{ltPropClass}}" id="{{ltPropId}}" type="file" name="{{ltPropName}}" onchange="{{action(\'change\', event, this)}}" multiple="{{ltPropMultiple}}" accept="{{ltPropAccept}}">\n\t<div tabindex="{{ltPropTabindex}}" class="fileUploadWrapper {{fileClass}}" ondragenter="{{action(\'drag\', event)}}" ondragleave="{{action(\'drag\', event)}}" ondragover="{{action(\'drag\', event)}}" ondrop="{{action(\'drop\', event)}}" onclick="{{action(\'click\', event)}}" style="outline: none;" onpaste="{{action(\'paste\', event)}}" onkeydown="{{action( \'keydown\', event)}}">\n\t\t<template is="if" value="{{ltPropYield}}"><template case="true">\n\t\t\t<lyte-yield yield-name="file" queue-list="{{queueList}}"></lyte-yield>\n\t\t</template><template case="false">\n\t\t\t<template is="if" value="{{ltPropMultiple}}"><template case="true">\n\t\t\t\t<lyte-file-select-area>\n\t\t\t \t\t<lyte-file-message class="fileMessage"> Click here </lyte-file-message>\n\t\t\t\t </lyte-file-select-area>\n\t\t\t\t <div class="uploadList">\n\t\t\t\t \t<template is="for" items="{{queueList}}" item="item" index="index">\n\t\t\t\t \t\t<div class="individual {{item.status}}">\n\t\t\t\t \t\t\t<div class="fileTypeDetail">\n\t\t\t\t\t \t\t\t<template is="if" value="{{item.src}}"><template case="true">\n\t\t\t\t\t \t\t\t\t\t<img class="thumbImage" src="{{item.src}}">\n\t\t\t\t \t\t\t\t</template><template case="false">\n\t\t\t\t \t\t\t\t\t<span class="fileTypeDefaultIcon {{item.fileType}}"></span>\n\t\t\t\t \t\t\t\t</template></template>\n\t\t\t \t\t\t\t</div>\n\t\t\t\t \t\t\t<lyte-text lt-prop-value="{{item.name}}"></lyte-text>\n\t\t\t\t \t\t\t<span class="fileSize">( {{lyteUiFileSize(item.size, ltPropFileUnit, ltPropDigits)}} )</span>\n\t\t\t\t \t\t\t<div class="fileStatus" data-completed="{{item.percentage}}">\n\t\t\t \t\t\t\t\t<div class="fileProgress {{item.status}}">\n\t\t\t \t\t\t\t\t\t<div style="width: {{item.percentage}}%"></div>\n\t\t\t \t\t\t\t\t</div>\n\t\t\t\t \t\t\t</div>\n\t\t\t\t \t\t\t<template is="if" value="{{expHandlers(item.status,\'==\',&quot;error&quot;)}}"><template case="true">\n\t\t\t\t \t\t\t\t<lyte-file-retry data-value="{{item.id}}"></lyte-file-retry>\n\t\t\t\t \t\t\t</template></template>\n\t\t\t\t \t\t\t<lyte-file-close data-value="{{item.id}}" class="{{item.status}}"></lyte-file-close>\n\t\t\t\t \t\t</div>\n\t\t\t\t \t</template>\n\t\t\t\t  </div>\n\t\t\t</template><template case="false">\n\t\t\t\t<lyte-file-select-area>\n\t\t\t \t\t<lyte-file-message class="fileMessage {{if(queueList.length, \'lyteHide\', \'\')}}"> \n\t\t\t \t\t\t<span class="lyteFileuploadMsg">\n\t\t\t \t\t\t\t{{ltPropMessage}}\n\t\t\t \t\t\t</span> \n\t\t\t \t\t</lyte-file-message>\n\t\t\t \t\t <div class="uploadList">\n\t\t\t\t\t \t<template is="for" items="{{queueList}}" item="item" index="index">\n\t\t\t\t\t \t\t<div class="individual {{item.status}}">\n\t\t\t\t\t \t\t\t<div class="fileTypeDetail">\n\t\t\t\t\t\t \t\t\t<template is="if" value="{{item.src}}"><template case="true">\n\t\t\t\t\t\t \t\t\t\t\t<img class="thumbImage" src="{{item.src}}">\n\t\t\t\t\t \t\t\t\t</template><template case="false">\n\t\t\t\t\t \t\t\t\t\t<span class="fileTypeDefaultIcon {{item.fileType}}"></span>\n\t\t\t\t\t \t\t\t\t</template></template>\n\t\t\t\t \t\t\t\t</div>\n\t\t\t\t\t \t\t\t<lyte-text lt-prop-value="{{item.name}}"></lyte-text>\n\t\t\t\t\t \t\t\t<span class="fileSize">( {{lyteUiFileSize(item.size, ltPropFileUnit, ltPropDigits)}} )</span>\n\t\t\t\t\t \t\t\t<div class="fileStatus" data-completed="{{item.percentage}}">\n\t\t\t\t \t\t\t\t\t<div class="fileProgress {{item.status}}">\n\t\t\t\t \t\t\t\t\t\t<div style="width: {{item.percentage}}%"></div>\n\t\t\t\t \t\t\t\t\t</div>\n\t\t\t\t\t \t\t\t</div>\n\t\t\t\t\t \t\t\t<template is="if" value="{{expHandlers(item.status,\'==\',&quot;error&quot;)}}"><template case="true">\n\t\t\t\t\t \t\t\t\t<lyte-file-retry data-value="{{item.id}}"></lyte-file-retry>\n\t\t\t\t\t \t\t\t</template></template>\n\t\t\t\t\t \t\t\t<lyte-file-close data-value="{{item.id}}" class="{{item.status}}"></lyte-file-close>\n\t\t\t\t\t \t\t</div>\n\t\t\t\t\t \t</template>\n\t\t\t\t\t  </div>\n\t\t\t\t </lyte-file-select-area>\n\t\t\t</template></template>\n\t\t\t \n\t\t</template></template>\n\t</div>\n</template>',_dynamicNodes:[{type:"attr",position:[1]},{type:"attr",position:[3]},{type:"attr",position:[3,1]},{type:"if",position:[3,1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"insertYield",position:[1]}]},false:{dynamicNodes:[{type:"attr",position:[1]},{type:"if",position:[1],cases:{true:{dynamicNodes:[{type:"componentDynamic",position:[1,1]},{type:"componentDynamic",position:[1]},{type:"attr",position:[3,1]},{type:"for",position:[3,1],dynamicNodes:[{type:"attr",position:[1]},{type:"attr",position:[1,1,1]},{type:"if",position:[1,1,1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]}]},false:{dynamicNodes:[{type:"attr",position:[1]}]}},default:{}},{type:"attr",position:[1,3]},{type:"componentDynamic",position:[1,3]},{type:"text",position:[1,5,1]},{type:"attr",position:[1,7]},{type:"attr",position:[1,7,1]},{type:"attr",position:[1,7,1,1],attr:{style:{name:"style",helperInfo:{name:"concat",args:["'width: '","item.percentage","'%'"]}}}},{type:"attr",position:[1,9]},{type:"if",position:[1,9],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"componentDynamic",position:[1]}]}},default:{}},{type:"attr",position:[1,11]},{type:"componentDynamic",position:[1,11]}]}]},false:{dynamicNodes:[{type:"attr",position:[1,1]},{type:"text",position:[1,1,1,1]},{type:"componentDynamic",position:[1,1]},{type:"attr",position:[1,3,1]},{type:"for",position:[1,3,1],dynamicNodes:[{type:"attr",position:[1]},{type:"attr",position:[1,1,1]},{type:"if",position:[1,1,1],cases:{true:{dynamicNodes:[{type:"attr",position:[1]}]},false:{dynamicNodes:[{type:"attr",position:[1]}]}},default:{}},{type:"attr",position:[1,3]},{type:"componentDynamic",position:[1,3]},{type:"text",position:[1,5,1]},{type:"attr",position:[1,7]},{type:"attr",position:[1,7,1]},{type:"attr",position:[1,7,1,1],attr:{style:{name:"style",helperInfo:{name:"concat",args:["'width: '","item.percentage","'%'"]}}}},{type:"attr",position:[1,9]},{type:"if",position:[1,9],cases:{true:{dynamicNodes:[{type:"attr",position:[1]},{type:"componentDynamic",position:[1]}]}},default:{}},{type:"attr",position:[1,11]},{type:"componentDynamic",position:[1,11]}]},{type:"componentDynamic",position:[1]}]}},default:{}}]}},default:{}}],_observedAttributes:["ltPropName","ltPropMultiple","ltPropAccept","ltPropId","ltPropClass","ltPropYield","ltPropMultipleUpload","ltPropFileLimit","ltPropParallel","ltPropAutoUpload","ltPropTriggerUpload","ltPropParamName","ltPropThumb","ltPropTabindex","ltPropRetry","ltPropFileUnit","ltPropDigits","ltPropMessage","ltPropChunk","ltPropChunkSize","ltPropChunkParallel","ltPropChunkRetry","ltPropAjax","queueList","currentUpload","fileClass"],init:function(){this.getMethods("beforeRender")&&this.executeMethod("beforeRender",this.$node)},didConnect:function(){this._file=this.$node.querySelector("input.fileuploadInput"),this.$node.upload=this.processqueue.bind(this),this.$node.removeUpload=function(t){t?this.removeFrmUpload(t,"queueList"):this.removeFrmUpload(this.data.queueList,"queueList",!0)}.bind(this),this.getMethods("afterRender")&&this.executeMethod("afterRender",this.$node)},didDestroy:function(){this.$node.removeUpload(),delete this._file,delete this.$node.upload,delete this.$node.removeUpload},data:function(){return{ltPropName:Lyte.attr("string",{default:"file"}),ltPropMultiple:Lyte.attr("boolean",{default:!0}),ltPropAccept:Lyte.attr("string",{default:""}),ltPropId:Lyte.attr("string",{default:""}),ltPropClass:Lyte.attr("string",{default:""}),ltPropYield:Lyte.attr("boolean",{default:!1}),ltPropMultipleUpload:Lyte.attr("boolean",{default:!0}),ltPropFileLimit:Lyte.attr("number",{default:void 0}),ltPropParallel:Lyte.attr("number",{default:2}),ltPropAutoUpload:Lyte.attr("boolean",{default:!0}),ltPropTriggerUpload:Lyte.attr("boolean",{default:!1}),ltPropParamName:Lyte.attr("array",{default:"file"}),ltPropThumb:Lyte.attr("boolean",{default:!0}),ltPropTabindex:Lyte.attr("number",{default:1}),ltPropRetry:Lyte.attr("number",{default:2}),ltPropFileUnit:Lyte.attr("string",{default:""}),ltPropDigits:Lyte.attr("number",{default:0}),ltPropMessage:Lyte.attr("string",{default:"Click here"}),ltPropChunk:Lyte.attr("boolean",{default:!1}),ltPropChunkSize:Lyte.attr("number",{default:2e6}),ltPropChunkParallel:Lyte.attr("number",{default:2}),ltPropChunkRetry:Lyte.attr("number",{default:2}),ltPropAjax:Lyte.attr("object",{default:{url:"/file-upload"}}),queueList:Lyte.attr("array",{default:[]}),currentUpload:Lyte.attr("array",{default:[]}),fileClass:Lyte.attr("string",{default:""})}},trigUpl:function(t){t.newValue&&(this.processqueue(),this.setData("ltPropTriggerUpload",!1))}.observes("ltPropTriggerUpload"),validate:function(t){for(var e=this.data.ltPropAccept.split(","),i=[],o=0;o<t.length;o++){for(var s,a={},r=0;r<e.length&&(a.type=!new RegExp(e[r].trim()).test(t[o].type),!a.type);r++);if(s=this.data.ltPropChunk&&t[o].size>this.data.ltPropChunkSize,a.size=t[o].size>this.data.ltPropFileLimit,!a.size&&!a.type||s){var n;if(this.getMethods("onBeforeAdd")&&(n=this.executeMethod("onBeforeAdd",t[o],this.$node)),0==n)continue;if(n&&n.then){i.push(n);var l=t[o];Promise.resolve(n).then(this.add.bind(this,l,s))}else this.add(t[o],s);if(!this.data.ltPropMultiple)break}else this.getMethods("onReject")&&this.executeMethod("onReject",t[o],a,this.$node)}this.data.ltPropAutoUpload&&(i.length?Lyte.resolvePromises(i).then(this.processqueue.bind(this)):this.processqueue())},add:function(t,e){var i=t.name.match(/.([A-z]+)$/),o={id:"lyte"+(new Date).getTime(),file:t,size:t.size,name:t.name,isChunk:e,retry:0,fileType:i?i[1]:""};this.data.ltPropThumb&&/image/i.test(t.type)&&Lyte.Component.set(o,"src",URL.createObjectURL(t)),Lyte.arrayUtils(this.data.queueList,"push",o),this.getMethods("onAdd")&&this.executeMethod("onAdd",t,this.$node)},chkId:function(t,e){return e.id==t},processqueue:function(t){for(var e=this.data,i=0;(e.ltPropMultipleUpload&&e.currentUpload.length<e.ltPropParallel||!e.ltPropMultipleUpload&&!e.currentUpload.length)&&e.queueList.length;){var o=e.queueList[i];if(t&&(t=t.constructor==Object?t.id:t,o=e.queueList[this.findIndex(e.queueList,this.chkId.bind(this,t))]),!o)break;if(/uploading|success/.test(o.status)){if(t)break;i++}else if("error"!=o.status||!(o.retry>=e.ltPropRetry-1||o.isChunk)||t){if(o.isChunk||Lyte.arrayUtils(e.currentUpload,"push",o),this.uploadFile(o),t)break;i++}else i++}},findIndex:function(t,e){if(e.constructor!=Function)return t.indexOf(e);for(var i=0;i<t.length;i++){if(e.call(t[i],t[i]))return i}},removeFrmUpload:function(t,e,i){t.constructor!=Array&&(t=[t]);for(var o=0;o<t.length;o++){id=t[o].id||t[o];var s=this.data[e],a=this.findIndex(s,this.chkId.bind(this,id));if(a>=0){if(!i&&this.getMethods("onBeforeRemove")&&0==this.executeMethod("onBeforeRemove",e,s[a],this.$node))continue;cur=s[a],"uploading"==cur.status&&cur.xhr&&cur.xhr.ret.abort(),Lyte.arrayUtils(s,"removeAt",a),a<=o&&o--}}!i&&this.data.ltPropAutoUpload&&this.processqueue()},uploadFile:function(t){var e,i=Lyte.deepCopyObject(this.data.ltPropAjax);this.getMethods("onBeforeUpload")&&(e=this.executeMethod("onBeforeUpload",t,i,this.$node)),e&&e.then?Promise.resolve(e).then(function(){t.isChunk?this.proceedChunk(t,i):this.proceedUpload(t,i)}.bind(this)):0!=e?t.isChunk?this.proceedChunk(t,i):this.proceedUpload(t,i):(this.removeFrmUpload(t.id,"queueList"),this.removeFrmUpload(t.id,"currentUpload"))},succFunc:function(t){var e=arguments[2].xhr.file;Lyte.Component.set(e,"status","success"),this.getMethods("onSuccess")&&this.executeMethod("onSuccess",t,e,this.$node),Lyte.objectUtils(e,"delete","xhr"),delete arguments[2].xhr.file,this.removeFrmUpload(e.id,"currentUpload")},reject:function(t){t.xhr.file.retry>=this.data.ltPropRetry-1?(Lyte.Component.set(t.xhr.file,"status","error"),this.getMethods("onError")&&this.executeMethod("onError",t,t.xhr.file,this.$node),Lyte.objectUtils(t.xhr.file,"delete","xhr"),this.removeFrmUpload(t.xhr.file.id,"currentUpload"),delete t.xhr.file):(Lyte.Component.set(t.xhr.file,"status","retrying"),Lyte.objectUtils(t.xhr.file,"add","retry",t.xhr.file.retry+1),this.removeFrmUpload(t.xhr.file.id,"currentUpload",!0),this.$node.upload(t.xhr.file.id))},progress:function(t){if(t.lengthComputable){var e=t.total,i=t.loaded,o=t.target.xhr;Lyte.Component.set(o.file,{size:e,loaded:i,percentage:Math.round(100*i/e)}),this.getMethods("onProgress")&&this.executeMethod("onProgress",t,o,o.file,this.$node)}},removeChunk:function(t,e,i){var o=this.data.currentUpload,s=this.findIndex(o,function(e){return e.chunkProp.id==t});s>-1&&(Lyte.arrayUtils(o,"removeAt",s),!i&&this.processChunkQueue(e.chunks))},chunkReject:function(t){var e=t.xhr.file,i=e.chunkProp.origin;e.retry<this.data.ltPropRetry-1?(Lyte.Component.set(e,"status","retrying"),Lyte.objectUtils(e,"add","retry",e.retry+1),this.removeChunk(e.chunkProp.id,i,!0),this.processChunkQueue(e,!0)):(Lyte.Component.set(e,"status","error"),this.removeChunk(e.chunkProp.id,i,!0),this.getMethods("onChunkError")&&this.executeMethod("onChunkError",t,e,i,this.$node),Lyte.objectUtils(e,"delete","xhr"),delete t.xhr.file,Lyte.Component.set(i,"error",i.error+1),"error"!=i.status&&(Lyte.Component.set(i,"status","error"),this.getMethods("onError")&&this.executeMethod("onError",e,i,this.$node)),i.error+i.finished==i.total?this.data.ltPropAutoUpload&&this.processqueue():this.processChunkQueue(i.chunks,!0))},chuckSuccess:function(t){var e=arguments[2].xhr.file,i=e.chunkProp.origin;Lyte.Component.set(e,"status","success"),this.removeChunk(e.chunkProp.id,i),this.getMethods("onChunkSuccess")&&this.executeMethod("onChunkSuccess",t,e,i,this.$node),Lyte.objectUtils(e,"delete","xhr"),delete arguments[2].xhr.file,Lyte.Component.set(i,"finished",i.finished+1),i.finished==i.total?(Lyte.Component.set(i,"status","success"),this.getMethods("onSuccess")&&this.executeMethod("onSuccess",i,this.$node),this.data.ltPropAutoUpload&&this.processqueue()):this.processChunkQueue(i.chunks,!0)},chunkProgress:function(t){if(t.lengthComputable){t.total;var e=t.loaded,i=t.target.xhr.file,o=i.chunkProp.origin,s=e-i.loaded;Lyte.Component.set(i,"loaded",e),Lyte.Component.set(o,{loaded:Math.min(o.loaded+s,o.size),percentage:Math.min(Math.round(100*(o.loaded+s)/o.size),100)}),this.getMethods("onProgress")&&this.executeMethod("onProgress",t,xhr,o,this.$node)}},proceedChunk:function(t,e){for(var i=this.data.ltPropChunkSize,o=t.size,s=0,a=[];s<=o;){var r=s,n=Math.min(o,s+=i);a.push({file:t.file.slice(r,n),chunkProp:{chunkOffset:r,chunkSize:n,chunkId:"lyteChunk"+(new Date).getTime(),chunkIndex:a.length,origin:t,chunkCount:Math.ceil(t.size/i),totalSize:t.size},name:t.file.name,loaded:0,retry:0})}Lyte.Component.set(t,{chunks:a,error:0,finished:0,total:a.length}),this.processChunkQueue(a)},processChunkQueue:function(t,e){var i=this.data,o=0;for(t.constructor!=Array&&(t=[t]);i.ltPropMultipleUpload&&i.currentUpload.length<i.ltPropChunkParallel||!i.ltPropMultipleUpload&&!i.currentUpload.length;){var s=t[o];if(!s)break;/success|uploading/.test(s.status)||e&&(!e||/error/.test(s.status))?o++:(file=s.chunkProp.origin,Lyte.Component.set(file,{status:"uploading",percentage:file.percentage||0,loaded:file.loaded||0,size:file.size}),this.proceedUpload(s,Lyte.deepCopyObject(i.ltPropAjax),!0),Lyte.arrayUtils(i.currentUpload,"push",s),o++)}},proceedUpload:function(t,e,i){if(!/success|uploading/.test(t.status)){var o,s=new FormData;s.append(this.data.ltPropParamName,t.file,t.name),e.success=i?this.chuckSuccess.bind(this):this.succFunc.bind(this),e.error=i?this.chunkReject.bind(this):this.reject.bind(this);var a=new XMLHttpRequest;if(e.type=e.type||"POST",t.xhr=a,a.file=t,a.upload.xhr=a,a.upload.addEventListener("progress",i?this.chunkProgress.bind(this):this.progress.bind(this),!1),e.xhr=function(){return a},e.data=e.data||s,e.processData=e.processData||!1,this.getMethods("onBeforeSend")&&(o=this.executeMethod("onBeforeSend",a,t,!!i,this.$node)),o&&o.then)Promise.resolve(o).then(function(){this.finishSend(e,a,t)}.bind(this));else{if(0==o)return this.removeFrmUpload(t.id,"queueList"),void this.removeFrmUpload(t.id,"currentUpload");o&&o.constructor==FormData&&(e.data=o),this.finishSend(e,a,t,i)}}},finishSend:function(t,e,i,o){Lyte.Component.set(i,"status","uploading");var s=$L.ajax(t);s.xhr=e,e.ret=s,this.getMethods("onSend")&&this.executeMethod("onSend",e,s,i,!!o,this.$node)},actions:{change:function(t,e){this.data.ltPropMultiple||this.$node.removeUpload(),this.validate(e.files)},drag:function(t){var e=t.type,i="onDrag",o=e.match(/drag(.+)/);if(o&&o[1]&&(i+=o[1].slice(0,1).toUpperCase()+o[1].slice(1),/enter|over/.test(t.type))){if("dragover"==t.type){var s=t.dataTransfer;if(s){var a=s.effectAllowed;s.dropEffect="move"===a||"linkMove"===a?"move":"copy"}}t.preventDefault()}"dragenter"==e?this.setData("fileClass","fileDragEnter"):"dragleave"==e&&this.setData("fileClass",""),this.getMethods(i)&&this.executeMethod(i,t,this.$node)},drop:function(t){var e=t.dataTransfer;if(e){if(this.getMethods("onBeforeDrop")&&0==this.executeMethod("onBeforeDrop",t,this.$node))return;t.preventDefault(),this.data.ltPropMultiple||this.$node.removeUpload(),this.validate(e.files),this.getMethods("onDrop")&&this.executeMethod("onDrop",t,this.$node)}},click:function(t){var e;if(!this.data.ltPropYield&&this.data.ltPropMultiple&&(t.shiftKey?t.preventDefault():$L("#lyteFileSelected.individual").removeAttr("id"),$L(t.target).closest(".individual").attr("id","lyteFileSelected")),!(t.ctrlKey||t.shiftKey||t.metaKey))if((e=$L(t.target).closest("lyte-file-close")).length)this.$node.removeUpload(e.eq(0).attr("data-value"));else if((e=$L(t.target).closest("lyte-file-retry")).length)this.$node.upload(e.eq(0).attr("data-value"));else if($L(t.target).closest("lyte-file-select-area").length){if(this.getMethods("onBeforeOpen")&&0==this.executeMethod("onBeforeOpen",t,this.$node))return;this._file.click()}},paste:function(t){for(var e=(t.clipboardData||window.clipboardData).items,i=[],o=0;o<e.length;o++){var s=e[o].getAsFile();s&&i.push(s)}if(i.length){if(this.getMethods("onBeforePaste")&&0==this.executeMethod("onBeforePaste",t,i,this.$node))return;this.data.ltPropMultiple||this.$node.removeUpload(),this.validate(i),this.getMethods("onPaste")&&this.executeMethod("onPaste",t,i,this.$node)}},keydown:function(t){if(8==t.which){for(var e=$L("#lyteFileSelected lyte-file-close",this.$node),i=0;i<e.length;i++)this.$node.removeUpload(e.eq(i).attr("data-value"));e.length&&t.preventDefault()}}}});